-- 实验教学计划表视图，view_timetable_plan
-- 刘博越
drop view if exists `view_timetable_plan`;
CREATE 
ALGORITHM=UNDEFINED 
DEFINER=`root`@`localhost` 
SQL SECURITY DEFINER 
VIEW `view_timetable_plan`AS 
select `ta`.`id` AS `appId`,`vts`.`termId` AS `termId`,group_concat(`ta`.`start_week` separator ',') AS `planTime`,group_concat((case `ta`.`weekday` when 1 then '一 ' when 2 then '二 ' when 3 then '三 ' when 4 then '四 ' when 5 then '五 ' when 6 then '六 ' when 7 then '日 ' end) separator ',') AS `weekday`,group_concat(`ta`.`start_class`,'-',`ta`.`end_class` separator ',') AS `classes`,(sum(((`ta`.`end_week` - `ta`.`start_week`) + 1)) * ((`ta`.`end_class` - `ta`.`start_class`) + 1)) AS `planHour`,'不跳' AS `jumpOrNot`,(((`ta`.`end_week` - `ta`.`start_week`) + 1) * ((`ta`.`end_class` - `ta`.`start_class`) + 1)) AS `lptime` from (`timetable_appointment` `ta` join `view_ta_same` `vts` on((`vts`.`appId` = `ta`.`id`))) where ((`vts`.`same_numbers` <= 1) and (`ta`.`start_week` = `ta`.`end_week`)) group by `ta`.`id` union select `ta`.`id` AS `appId`,`vts`.`termId` AS `termId`,group_concat(`ta`.`start_week`,'-',`ta`.`end_week` separator ',') AS `planTime`,group_concat((case `ta`.`weekday` when 1 then '一 ' when 2 then '二 ' when 3 then '三 ' when 4 then '四 ' when 5 then '五 ' when 6 then '六 ' when 7 then '日 ' end) separator ',') AS `weekday`,group_concat(`ta`.`start_class`,'-',`ta`.`end_class` separator ',') AS `classes`,(sum(((`ta`.`end_week` - `ta`.`start_week`) + 1)) * ((`ta`.`end_class` - `ta`.`start_class`) + 1)) AS `planHour`,'不跳' AS `jumpOrNot`,(((`ta`.`end_week` - `ta`.`start_week`) + 1) * ((`ta`.`end_class` - `ta`.`start_class`) + 1)) AS `lptime` from (`timetable_appointment` `ta` join `view_ta_same` `vts` on((`vts`.`appId` = `ta`.`id`))) where ((`vts`.`same_numbers` <= 1) and (`ta`.`start_week` <> `ta`.`end_week`)) group by `ta`.`id` union select `ta`.`id` AS `appId`,`vts`.`termId` AS `termId`,group_concat(`ta`.`start_week` separator ',') AS `planTime`,group_concat((case `ta`.`weekday` when 1 then '一 ' when 2 then '二 ' when 3 then '三 ' when 4 then '四 ' when 5 then '五 ' when 6 then '六 ' when 7 then '日 ' end) separator ',') AS `weekday`,group_concat(`ta`.`start_class`,'-',`ta`.`end_class` separator ',') AS `classes`,(sum(((`tas`.`end_week` - `tas`.`start_week`) + 1)) * ((`tas`.`end_class` - `tas`.`start_class`) + 1)) AS `planHour`,'跳' AS `jumpOrNot`,(((`ta`.`end_week` - `ta`.`start_week`) + 1) * ((`ta`.`end_class` - `ta`.`start_class`) + 1)) AS `lptime` from ((`timetable_appointment_same_number` `tas` left join `timetable_appointment` `ta` on((`tas`.`appointment_id` = `ta`.`id`))) left join `view_ta_same` `vts` on((`vts`.`appId` = `ta`.`id`))) where ((`vts`.`same_numbers` > 1) and (`tas`.`start_week` = `tas`.`end_week`)) group by `ta`.`id` union select `ta`.`id` AS `appId`,`vts`.`termId` AS `termId`,group_concat(`tas`.`start_week`,'-',`tas`.`end_week` separator ',') AS `planTime`,group_concat((case `ta`.`weekday` when 1 then '一 ' when 2 then '二 ' when 3 then '三 ' when 4 then '四 ' when 5 then '五 ' when 6 then '六 ' when 7 then '日 ' end) separator ',') AS `weekday`,group_concat(`ta`.`start_class`,'-',`ta`.`end_class` separator ',') AS `classes`,(sum(((`tas`.`end_week` - `tas`.`start_week`) + 1)) * ((`tas`.`end_class` - `tas`.`start_class`) + 1)) AS `planHour`,'跳' AS `jumpOrNot`,(((`ta`.`end_week` - `ta`.`start_week`) + 1) * ((`ta`.`end_class` - `ta`.`start_class`) + 1)) AS `lptime` from ((`timetable_appointment_same_number` `tas` left join `timetable_appointment` `ta` on((`tas`.`appointment_id` = `ta`.`id`))) left join `view_ta_same` `vts` on((`vts`.`appId` = `ta`.`id`))) where ((`vts`.`same_numbers` > 1) and (`tas`.`start_week` <> `tas`.`end_week`)) group by `ta`.`id` ;
